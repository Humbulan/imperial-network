{% extends "base.html" %}
{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-dark text-white">
                <h3>Welcome, {{ user.username }}! 
                    <small class="text-muted" style="color: #aaa !important;">
                        ({{ user.role }})
                    </small>
                </h3>
            </div>
            <div class="card-body">
                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stat-card bg-primary text-white">
                            <div class="card-body">
                                <h5>My Orders</h5>
                                <h2>{{ orders|length }}</h2>
                                <i class="fas fa-shopping-cart position-absolute" style="right: 20px; top: 20px; opacity: 0.5; font-size: 40px;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-success text-white">
                            <div class="card-body">
                                <h5>My Payments</h5>
                                <h2>{{ payments|length if payments else 0 }}</h2>
                                <i class="fas fa-credit-card position-absolute" style="right: 20px; top: 20px; opacity: 0.5; font-size: 40px;"></i>
                            </div>
                        </div>
                    </div>
                    {% if user.role == 'admin' %}
                    <div class="col-md-3">
                        <div class="card stat-card bg-warning text-white">
                            <div class="card-body">
                                <h5>Total Users</h5>
                                <h2>{{ stats.total_users if stats else 0 }}</h2>
                                <i class="fas fa-users position-absolute" style="right: 20px; top: 20px; opacity: 0.5; font-size: 40px;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-info text-white">
                            <div class="card-body">
                                <h5>Total Orders</h5>
                                <h2>{{ stats.total_orders if stats else 0 }}</h2>
                                <i class="fas fa-box position-absolute" style="right: 20px; top: 20px; opacity: 0.5; font-size: 40px;"></i>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Action Buttons -->
                            <a href="/notification-settings" class="btn btn-outline-info">
                                <i class="fas fa-bell"></i> Notifications
                            </a>
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="btn-group" role="group">
                            <a href="/create_order" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Create Order
                            </a>
                            <a href="/my_orders" class="btn btn-outline-primary">
                                <i class="fas fa-list"></i> My Orders
                            </a>
                            <a href="/create_payment" class="btn btn-success">
                                <i class="fas fa-money-bill"></i> Make Payment
                            </a>
                            <a href="/my_payments" class="btn btn-outline-success">
                                <i class="fas fa-history"></i> Payment History
                            </a>
                            <a href="/ussd/admin" class="btn btn-info">
                                <i class="fas fa-phone"></i> USSD Admin
                            </a>
                            <a href="/ai/dashboard" class="btn btn-warning">
                                <i class="fas fa-robot"></i> AI Analytics
                            </a>
                            <a href="/mobile" class="btn btn-secondary">
                                <i class="fas fa-mobile-alt"></i> Mobile SDK
                            </a>
                            <a href="/monitor" class="btn btn-danger">
                                <i class="fas fa-chart-line"></i> Monitor
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Admin Section -->
                {% if user.role == 'admin' %}
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h4><i class="fas fa-crown"></i> Admin Tools</h4>
                            </div>
                            <div class="card-body">
                                <div class="btn-group w-100" role="group">
                                    <a href="/admin/villages" class="btn btn-outline-warning">
                                        <i class="fas fa-city"></i> Villages
                                    </a>
                                    <a href="/admin/keys" class="btn btn-outline-warning">
                                        <i class="fas fa-key"></i> API Keys
                                    </a>
                                    <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#addVillageModal">
                                        <i class="fas fa-plus-circle"></i> Add Village
                                    </button>
                                    <a href="/api/status/full" class="btn btn-outline-warning" target="_blank">
                                        <i class="fas fa-heartbeat"></i> Full Status
                                    </a>
                                </div>
                                        <i class="fas fa-plus-circle"></i> Add Village
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

<div class="modal fade" id="addVillageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning"><h5>Add New Village</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <form id="dashAddForm">
        <div class="modal-body">
          <input type="text" name="name" class="form-control mb-2" placeholder="Village Name" required>
          <input type="text" name="district" class="form-control mb-2" placeholder="District" required>
          <input type="text" name="region" class="form-control mb-2" placeholder="Region" required>
        </div>
        <div class="modal-footer"><button type="submit" class="btn btn-warning">Save</button></div>
      </form>
    </div>
  </div>
</div>
<script>
document.getElementById("dashAddForm")?.addEventListener("submit", function(e) {
    e.preventDefault();
    fetch("/api/admin/villages", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(Object.fromEntries(new FormData(e.target)))
    }).then(() => { alert("Added!"); location.reload(); });
});
</script>
                <!-- Recent Orders -->
                <h4>Recent Orders</h4>
                {% if orders %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders[:5] %}
                            <tr>
                                <td>{{ order.order_number }}</td>
                                <td>{{ order.description }}</td>
                                <td>R{{ "%.2f"|format(order.amount) }}</td>
                                <td>
                                    {% if order.status == 'pending' %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% elif order.status == 'completed' %}
                                        <span class="badge bg-success">Completed</span>
                                    {% else %}
                                        <span class="badge bg-info">{{ order.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ order.created_at.strftime('%Y-%m-%d') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No orders yet. <a href="/create_order">Create your first order!</a></p>
                {% endif %}

                <!-- Recent Payments -->
                <h4 class="mt-4">Recent Payments</h4>
                {% if payments %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Payment #</th>
                                <th>Method</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments[:5] %}
                            <tr>
                                <td>{{ payment.payment_id }}</td>
                                <td>{{ payment.payment_method }}</td>
                                <td>R{{ "%.2f"|format(payment.amount) }}</td>
                                <td>
                                    {% if payment.status == 'pending' %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% elif payment.status == 'completed' %}
                                        <span class="badge bg-success">Completed</span>
                                    {% else %}
                                        <span class="badge bg-info">{{ payment.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ payment.created_at.strftime('%Y-%m-%d') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No payments yet. <a href="/create_payment">Make your first payment!</a></p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}


<div class="modal fade" id="addVillageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
